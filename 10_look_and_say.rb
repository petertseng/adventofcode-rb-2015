rounds = [40, 50]

x = (!ARGV.empty? && !File.exist?(ARGV.first) ? ARGV.first : ARGF.read).freeze

# The elements referenced by the Cosmological Theorem
ELEMENTS = [
  [1112                                      ,  4, [62]                    ],
  [1112133                                   ,  7, [63, 61]                ],
  [111213322112                              , 12, [64]                    ],
  [111213322113                              , 12, [65]                    ],
  [1113                                      ,  4, [67]                    ],
  [11131                                     ,  5, [68]                    ],
  [111311222112                              , 12, [83, 54]                ],
  [111312                                    ,  6, [69]                    ],
  [11131221                                  ,  8, [70]                    ],
  [1113122112                                , 10, [75]                    ],
  [1113122113                                , 10, [76]                    ],
  [11131221131112                            , 14, [81]                    ],
  [111312211312                              , 12, [77]                    ],
  [11131221131211                            , 14, [78]                    ],
  [111312211312113211                        , 18, [79]                    ],
  [111312211312113221133211322112211213322112, 42, [80, 28, 89]            ],
  [111312211312113221133211322112211213322113, 42, [80, 28, 90]            ],
  [11131221131211322113322112                , 26, [80, 29]                ],
  [11131221133112                            , 14, [74, 28, 91]            ],
  [1113122113322113111221131221              , 28, [74, 31]                ],
  [11131221222112                            , 14, [71]                    ],
  [111312212221121123222112                  , 24, [72]                    ],
  [111312212221121123222113                  , 24, [73]                    ],
  [11132                                     ,  5, [82]                    ],
  [1113222                                   ,  7, [85]                    ],
  [1113222112                                , 10, [86]                    ],
  [1113222113                                , 10, [87]                    ],
  [11133112                                  ,  8, [88, 91]                ],
  [12                                        ,  2, [0]                     ],
  [123222112                                 ,  9, [2]                     ],
  [123222113                                 ,  9, [3]                     ],
  [12322211331222113112211                   , 23, [1, 60, 28, 84]         ],
  [13                                        ,  2, [4]                     ],
  [131112                                    ,  6, [27]                    ],
  [13112221133211322112211213322112          , 32, [23, 32, 60, 28, 89]    ],
  [13112221133211322112211213322113          , 32, [23, 32, 60, 28, 90]    ],
  [13122112                                  ,  8, [6]                     ],
  [132                                       ,  3, [7]                     ],
  [13211                                     ,  5, [8]                     ],
  [132112                                    ,  6, [9]                     ],
  [1321122112                                , 10, [20]                    ],
  [132112211213322112                        , 18, [21]                    ],
  [132112211213322113                        , 18, [22]                    ],
  [132113                                    ,  6, [10]                    ],
  [1321131112                                , 10, [18]                    ],
  [13211312                                  ,  8, [11]                    ],
  [1321132                                   ,  7, [12]                    ],
  [13211321                                  ,  8, [13]                    ],
  [132113212221                              , 12, [14]                    ],
  [13211321222113222112                      , 20, [17]                    ],
  [1321132122211322212221121123222112        , 34, [15]                    ],
  [1321132122211322212221121123222113        , 34, [16]                    ],
  [13211322211312113211                      , 20, [19]                    ],
  [1321133112                                , 10, [5, 60, 28, 91]         ],
  [1322112                                   ,  7, [25]                    ],
  [1322113                                   ,  7, [26]                    ],
  [13221133112                               , 11, [24, 28, 91]            ],
  [1322113312211                             , 13, [24, 28, 66]            ],
  [132211331222113112211                     , 21, [24, 28, 84]            ],
  [13221133122211332                         , 17, [24, 28, 67, 60, 28, 88]],
  [22                                        ,  2, [60]                    ],
  [3                                         ,  1, [32]                    ],
  [3112                                      ,  4, [39]                    ],
  [3112112                                   ,  7, [40]                    ],
  [31121123222112                            , 14, [41]                    ],
  [31121123222113                            , 14, [42]                    ],
  [3112221                                   ,  7, [37, 38]                ],
  [3113                                      ,  4, [43]                    ],
  [311311                                    ,  6, [47]                    ],
  [31131112                                  ,  8, [53]                    ],
  [3113112211                                , 10, [48]                    ],
  [3113112211322112                          , 16, [49]                    ],
  [3113112211322112211213322112              , 28, [50]                    ],
  [3113112211322112211213322113              , 28, [51]                    ],
  [311311222                                 ,  9, [46, 37]                ],
  [311311222112                              , 12, [46, 54]                ],
  [311311222113                              , 12, [46, 55]                ],
  [3113112221131112                          , 16, [46, 56]                ],
  [311311222113111221                        , 18, [46, 57]                ],
  [311311222113111221131221                  , 24, [46, 58]                ],
  [31131122211311122113222                   , 23, [46, 59]                ],
  [3113112221133112                          , 16, [46, 32, 60, 28, 91]    ],
  [311312                                    ,  6, [44]                    ],
  [31132                                     ,  5, [45]                    ],
  [311322113212221                           , 15, [52]                    ],
  [311332                                    ,  6, [37, 28, 88]            ],
  [3113322112                                , 10, [37, 29]                ],
  [3113322113                                , 10, [37, 30]                ],
  [312                                       ,  3, [33]                    ],
  [312211322212221121123222112               , 27, [34]                    ],
  [312211322212221121123222113               , 27, [35]                    ],
  [32112                                     ,  5, [36]                    ],
].freeze
ELEMENTS.each { |e| e[2].freeze; e.freeze }

CACHE = Hash.new { |h, k| h[k] = {} }

as_string, index = ELEMENTS.map.with_index { |(elt, _, _), i| [elt.to_s, i] }.bsearch { |elt, _| x <= elt }
raise "#{x} is an invalid starting seed" if as_string != x

def length(element_index, rounds)
  return ELEMENTS[element_index][1] if rounds == 0
  CACHE[rounds][element_index] ||= ELEMENTS[element_index][2].sum { |c|
    length(c, rounds - 1)
  }
end

def pre_fill_cache(max_round)
  current_cache = ELEMENTS.map { |elt| elt[1] }
  max_round.times {
    current_cache = ELEMENTS.map { |elt|
      elt[2].sum { |c| current_cache[c] }
    }
  }
  CACHE[max_round] = current_cache.freeze
end

rounds.each { |r|
  # Pre-fill the cache so we don't make too many recursive calls to length.
  pre_fill_cache(r - ELEMENTS.length) if r > ELEMENTS.length
  puts length(index, r)
}
